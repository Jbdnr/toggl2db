<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monthly Time Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding: 1.5rem; }
      .table-wrap { overflow: auto; }
      table thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
      table { border-collapse: collapse; }
      table th, table td { border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; }
      .numeric { text-align: right; }
      .muted { color: #6c757d; }
      .controls { gap: .5rem; align-items: center; }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h3 class="mb-0">Monthly Time Report</h3>
          <div class="muted">Showing: <strong>{{ year }}-{{ "%02d"|format(month) }}</strong></div>
        </div>

        <form class="d-flex controls" method="get" action="/">
          <input id="month" name="month" type="number" class="form-control" min="1" max="12" value="{{ month }}" style="width:5.5rem">
          <input id="year" name="year" type="number" class="form-control" min="1970" max="2100" value="{{ year }}" style="width:6.5rem">
          <button class="btn btn-primary" type="submit">Go</button>

          <div class="btn-group">
            <button id="prevBtn" type="button" class="btn btn-outline-secondary">◀ Prev</button>
            <button id="nextBtn" type="button" class="btn btn-outline-secondary">Next ▶</button>
          </div>

          <a href="{{ url_for('routes.import_data', year=year, month=month) }}" class="btn btn-warning">Sync data</a>

          <button id="csvBtn" type="button" class="btn btn-outline-success">Export CSV</button>
          <button id="copyBtn" type="button" class="btn btn-outline-secondary">Copy</button>
        </form>
      </div>

      <div class="table-wrap border rounded">
        <table id="reportTable" class="table table-sm table-striped mb-0" cellspacing="0">
          <thead>
            <tr>
              {%- for h in headers %}
                <th scope="col">{{ h }}</th>
              {%- endfor %}
            </tr>
          </thead>
          <tbody>
            {%- for row in rows %}
            <tr>
              {%- for cell in row %}
                <td{%- if cell is number %} class="numeric"{%- endif %}>{{ cell if cell is not none else '' }}</td>
              {%- endfor %}
            </tr>
            {%- else %}
            <tr><td colspan="{{ headers|length }}" class="text-center py-4 muted">No data found for this period.</td></tr>
            {%- endfor %}
          </tbody>
          <tfoot>
            <tr id="totalsRow"></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const monthInput = document.getElementById('month');
      const yearInput = document.getElementById('year');
      document.getElementById('prevBtn').addEventListener('click', () => changeMonth(-1));
      document.getElementById('nextBtn').addEventListener('click', () => changeMonth(1));
      function changeMonth(delta) {
        let m = parseInt(monthInput.value, 10);
        let y = parseInt(yearInput.value, 10);
        m += delta;
        if (m < 1) { m = 12; y -= 1; }
        if (m > 12) { m = 1; y += 1; }
        monthInput.value = m;
        yearInput.value = y;
        monthInput.form.submit();
      }

      function tableToCSV(table) {
        const rows = Array.from(table.querySelectorAll('tr'));
        return rows.map(r => {
          const cells = Array.from(r.querySelectorAll('th,td'));
          return cells.map(c => '"' + String(c.innerText).replace(/"/g, '""') + '"').join(',');
        }).join('\n');
      }
      document.getElementById('csvBtn').addEventListener('click', () => {
        const csv = tableToCSV(document.getElementById('reportTable'));
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report-{{ year }}-{{ "%02d"|format(month) }}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      document.getElementById('copyBtn').addEventListener('click', async () => {
        try {
          const csv = tableToCSV(document.getElementById('reportTable'));
          await navigator.clipboard.writeText(csv);
          alert('Table copied to clipboard (CSV)');
        } catch (e) {
          alert('Copy failed: ' + e);
        }
      });

      (function computeTotals(){
        const table = document.getElementById('reportTable');
        const headerCells = table.tHead.rows[0].cells;
        const colCount = headerCells.length;
        const totals = new Array(colCount).fill(null);
        const bodyRows = table.tBodies[0].rows;
        for (let r=0; r<bodyRows.length; r++){
          const cells = bodyRows[r].cells;
          for (let c=0; c<cells.length; c++){
            const text = cells[c].innerText.trim();
            if (text === '') continue;
            const normalized = text.replace(/,/g, '');
            const num = Number(normalized);
            if (!isNaN(num)) {
              totals[c] = (totals[c] === null) ? num : totals[c] + num;
            }
          }
        }
        if (totals.some(v => v !== null)){
          const tr = document.getElementById('totalsRow');
          for (let c=0; c<colCount; c++){
            const td = document.createElement('td');
            if (totals[c] !== null){
              td.className = 'numeric fw-bold';
              td.innerText = totals[c].toLocaleString(undefined, { maximumFractionDigits: 2 });
            } else {
              td.innerHTML = (c===0) ? '<strong>Totals</strong>' : '';
            }
            tr.appendChild(td);
          }
        }
      })();

      document.querySelectorAll('#reportTable thead th').forEach((th, idx) => {
        th.style.cursor = 'pointer';
        th.addEventListener('click', () => {
          const table = th.closest('table');
          const tbody = table.tBodies[0];
          const rows = Array.from(tbody.rows);
          const currentAsc = th.dataset.asc === 'true';
          rows.sort((a,b) => {
            const A = a.cells[idx].innerText.trim();
            const B = b.cells[idx].innerText.trim();
            const An = Number(A.replace(/,/g, ''));
            const Bn = Number(B.replace(/,/g, ''));
            if (!isNaN(An) && !isNaN(Bn)) return currentAsc ? Bn - An : An - Bn;
            return currentAsc ? B.localeCompare(A) : A.localeCompare(B);
          });
          rows.forEach(r => tbody.appendChild(r));
          th.dataset.asc = (!currentAsc).toString();
        });
      });
    </script>
  </body>
</html>
